# 案件详细页面审查流程图

## 完整审查流程架构图

```mermaid
graph TD
    A[用户进入案件详细页面] --> B{选择操作模式}
    
    B -->|阅览| C[阅览模式]
    B -->|编辑| D[编辑模式]
    B -->|审查| E[审查模式]
    B -->|导出| F[导出模式]
    B -->|中止| G[中止模式]
    B -->|终了| H[终了模式]
    
    %% 阅览模式
    C --> C1[只读显示]
    C1 --> C2[蓝色样式]
    C2 --> C3[无操作权限]
    
    %% 编辑模式
    D --> D1[可编辑控件]
    D1 --> D2[白色背景]
    D2 --> D3[保存数据]
    D3 --> D4[提交审查]
    D4 --> E
    
    %% 审查模式 - 主要流程
    E --> E1[设置审查模式界面]
    E1 --> E2[隐藏未提交Tab]
    E2 --> E3[设置项目级别颜色]
    E3 --> E4[显示同意/不同意按钮]
    E4 --> E5{选择审查操作}
    
    %% 项目级别颜色设置
    E3 --> E3A[遍历所有可见Tab]
    E3A --> E3B[遍历Tab内所有控件]
    E3B --> E3C{检查控件审查状态}
    E3C -->|未审查| E3D[设置白色背景]
    E3C -->|已通过| E3E[设置灰色背景]
    E3C -->|重新编辑| E3F[设置红色背景]
    E3D --> E3G[继续下一个控件]
    E3E --> E3G
    E3F --> E3G
    E3G --> E3H{还有控件?}
    E3H -->|是| E3B
    E3H -->|否| E3I{还有Tab?}
    E3I -->|是| E3A
    E3I -->|否| E4
    
    %% 审查操作选择
    E5 -->|同意| E6[同意审查流程]
    E5 -->|不同意| E7[不同意审查流程]
    E5 -->|切换Tab| E8[Tab切换处理]
    
    %% 同意审查流程
    E6 --> E6A[获取当前Tab索引]
    E6A --> E6B[创建同意审查记录]
    E6B --> E6C[保存到数据库]
    E6C --> E6D[检查所有Tab状态]
    E6D --> E6E{所有Tab都同意?}
    E6E -->|是| E6F[更新案件状态为审查完成]
    E6E -->|否| E6G[保持当前状态]
    E6F --> E6H[更新控件颜色]
    E6G --> E6H
    E6H --> E6I[显示成功消息]
    
    %% 不同意审查流程
    E7 --> E7A[获取当前Tab索引]
    E7A --> E7B[创建不同意审查记录]
    E7B --> E7C[保存到数据库]
    E7C --> E7D[更新案件状态为需要修改]
    E7D --> E7E[更新控件颜色]
    E7E --> E7F[显示成功消息]
    
    %% Tab切换处理
    E8 --> E8A[获取选中Tab]
    E8A --> E8B[重新设置控件颜色]
    E8B --> E5
    
    %% 导出模式
    F --> F1[只读显示]
    F1 --> F2[添加导出按钮]
    F2 --> F3[Excel导出]
    F2 --> F4[PDF导出]
    
    %% 中止模式
    G --> G1[隐藏TabControl]
    G1 --> G2[显示中止面板]
    G2 --> G3[红色中止标记]
    
    %% 终了模式
    H --> H1[检查所有Tab同意状态]
    H1 --> H2{所有Tab都同意?}
    H2 -->|是| H3[设置终了状态]
    H2 -->|否| H4[显示错误消息]
    H3 --> H5[绿色背景显示]
    
    %% 样式定义
    classDef mode fill:#e1f5fe,stroke:#01579b,color:#01579b
    classDef process fill:#f3e5f5,stroke:#4a148c,color:#4a148c
    classDef decision fill:#fff3e0,stroke:#e65100,color:#e65100
    classDef color fill:#e8f5e8,stroke:#2e7d32,color:#2e7d32
    classDef success fill:#e8f5e8,stroke:#2e7d32,color:#2e7d32
    classDef error fill:#ffebee,stroke:#c62828,color:#c62828
    
    class B,C,D,E,F,G,H mode
    class E1,E2,E3,E4,E6A,E6B,E6C,E7A,E7B,E7C,E8A,E8B process
    class E5,E6E,H2 decision
    class E3A,E3B,E3C,E3D,E3E,E3F,E3G,E3H,E3I color
    class E6F,E6G,E6H,E6I,E7D,E7E,E7F,H3,H5 success
    class H4 error
```

## 项目级别颜色判断流程图

```mermaid
flowchart TD
    A[开始颜色判断] --> B[获取字段审查历史]
    B --> C{是否有审查记录?}
    
    C -->|否| D[返回: 未审查]
    C -->|是| E[获取最新审查记录]
    
    E --> F{最新审查状态?}
    F -->|不同意| G[返回: 未审查]
    F -->|待审查| H[返回: 未审查]
    F -->|同意| I[检查是否重新编辑]
    
    I --> J[获取字段修改历史]
    J --> K{同意后是否被修改?}
    K -->|否| L[返回: 已通过]
    K -->|是| M[返回: 重新编辑]
    
    D --> N[设置白色背景]
    G --> N
    H --> N
    L --> O[设置灰色背景]
    M --> P[设置红色背景]
    
    N --> Q[继续下一个控件]
    O --> Q
    P --> Q
    
    %% 样式定义
    classDef status fill:#e3f2fd,stroke:#1976d2,color:#1976d2
    classDef color fill:#f1f8e9,stroke:#558b2f,color:#558b2f
    classDef decision fill:#fff8e1,stroke:#f57f17,color:#f57f17
    
    class B,E,I,J status
    class C,F,K decision
    class D,G,H,L,M color
    class N,O,P color
```

## 审查状态转换图

```mermaid
stateDiagram-v2
    [*] --> 未提交
    未提交 --> 待审查 : 提交审查
    待审查 --> 同意 : 审查同意
    待审查 --> 不同意 : 审查不同意
    同意 --> 重新编辑 : 字段被修改
    不同意 --> 待审查 : 重新提交
    重新编辑 --> 待审查 : 重新提交审查
    同意 --> [*] : 案件终了
    
    note right of 未提交
        白色背景
        从未被审查过
    end note
    
    note right of 待审查
        白色背景
        等待审查
    end note
    
    note right of 同意
        灰色背景
        审查通过
    end note
    
    note right of 不同意
        白色背景
        需要修改
    end note
    
    note right of 重新编辑
        红色背景
        需要重新审查
    end note
```

## 核心方法调用关系图

```mermaid
graph LR
    A[SetReviewMode] --> B[SetReviewModeControlColors]
    B --> C[SetTabPageControlColors]
    C --> D[GetControlReviewColor]
    D --> E[GetFieldReviewStatus]
    E --> F[IsFieldModifiedAfterApproval]
    
    G[btnApprove_Click] --> H[ApproveReview]
    H --> I[UpdateTabStatus]
    I --> J[SetReviewModeControlColors]
    
    K[btnReject_Click] --> L[RejectReview]
    L --> I
    
    M[TabControl_SelectedIndexChanged] --> C
    
    %% 数据源
    N[_reviewLogs] --> E
    O[_caseDetails] --> F
    
    %% 样式定义
    classDef method fill:#e8f5e8,stroke:#2e7d32,color:#2e7d32
    classDef data fill:#fff3e0,stroke:#e65100,color:#e65100
    classDef event fill:#f3e5f5,stroke:#4a148c,color:#4a148c
    
    class A,B,C,D,E,F,G,H,I,J,K,L,M method
    class N,O data
    class M event
```

## 审查流程详细步骤

### 1. 进入审查模式
1. 用户点击"审查"按钮
2. 系统调用 `SetReviewMode()`
3. 隐藏未提交的标签页
4. 调用 `SetReviewModeControlColors()` 设置颜色
5. 显示同意/不同意按钮

### 2. 项目级别颜色设置
1. 遍历所有可见标签页
2. 对每个标签页调用 `SetTabPageControlColors()`
3. 遍历标签页内所有控件
4. 对每个控件调用 `GetControlReviewColor()`
5. 根据审查状态设置不同颜色

### 3. 审查操作处理
1. 用户选择同意或不同意
2. 调用对应的业务逻辑方法
3. 保存审查记录到数据库
4. 更新案件状态
5. 重新设置控件颜色
6. 显示操作结果

### 4. 标签页切换
1. 用户切换标签页
2. 触发 `TabControl_SelectedIndexChanged` 事件
3. 重新设置当前标签页的控件颜色

## 颜色规则总结

| 审查状态 | 背景颜色 | 含义 | 触发条件 |
|---------|---------|------|----------|
| 未审查 | 白色 | 需要审查 | 从未审查过或最新状态为"不同意" |
| 已通过 | 灰色 | 审查通过 | 最新状态为"同意"且未重新编辑 |
| 重新编辑 | 红色 | 需要重新审查 | 同意后被重新编辑并提交 |

## 技术实现要点

### 1. 数据依赖
- `_reviewLogs`: 审查记录历史
- `_caseDetails`: 字段修改历史
- `control.Tag`: 字段标识

### 2. 性能优化
- 只在审查模式下设置颜色
- 只在必要时更新颜色
- 使用缓存避免重复计算

### 3. 用户体验
- 颜色变化实时生效
- 颜色区分明显
- 操作反馈及时

这个流程图完整展示了案件详细页面的审查流程，特别是新增的项目级别颜色显示功能，帮助审查人员更高效地进行案件审查工作。 