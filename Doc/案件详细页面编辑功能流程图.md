# 案件详细页面编辑功能流程图

## 功能概述
案件详细页面编辑功能支持用户对案件信息进行修改、保存和提交审查，包含模板切换、数据验证、遮罩显示等特性。

## 编辑功能流程图

```mermaid
flowchart TD
    A[用户点击编辑按钮] --> B[检查编辑权限]
    B --> C{是否有编辑权限?}
    C -->|否| D[显示权限不足提示]
    C -->|是| E[切换到编辑模式]
    
    E --> F[设置界面为编辑状态]
    F --> G[清除之前的遮罩层]
    G --> H[设置控件为可编辑状态]
    H --> I[设置控件样式为白色背景]
    
    I --> J[检查各标签页审查状态]
    J --> K{是否有待审查的标签页?}
    K -->|是| L[为待审查标签页添加遮罩]
    K -->|否| M[显示所有标签页为可编辑]
    
    L --> N[显示正在审查中提示]
    M --> O[用户开始编辑数据]
    
    O --> P[用户修改表单数据]
    P --> Q{用户操作类型}
    
    Q -->|保存| R[调用模板保存数据]
    Q -->|提交审查| S[验证数据完整性]
    Q -->|切换标签页| T[更新标签页状态]
    
    R --> U[模板提取修改的数据]
    U --> V[业务逻辑层处理保存]
    V --> W{保存是否成功?}
    W -->|是| X[显示保存成功提示]
    W -->|否| Y[显示保存失败提示]
    X --> Z[重新加载数据]
    Y --> Z
    Z --> AA[更新标签页状态显示]
    
    S --> BB{数据验证通过?}
    BB -->|否| CC[显示验证错误提示]
    BB -->|是| DD[创建审查记录]
    CC --> P
    DD --> EE[更新案件状态为待审查]
    EE --> FF[显示提交成功提示]
    FF --> GG[切换到审查模式]
    
    T --> HH[检查目标标签页状态]
    HH --> II{标签页是否被遮罩?}
    II -->|是| JJ[显示遮罩提示信息]
    II -->|否| KK[正常切换标签页]
    JJ --> P
    KK --> P
    
    AA --> P
    GG --> LL[编辑功能完成]
    
    style A fill:#e1f5fe
    style E fill:#f3e5f5
    style L fill:#fff3e0
    style R fill:#e8f5e8
    style S fill:#fff8e1
    style GG fill:#f1f8e9
```

## 详细流程说明

### 1. 编辑模式启动流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 界面层
    participant BL as 业务逻辑层
    participant DAL as 数据访问层
    participant TM as 模板系统
    
    U->>UI: 点击编辑按钮
    UI->>BL: 检查编辑权限
    BL->>DAL: 查询案件状态
    DAL-->>BL: 返回案件信息
    BL-->>UI: 返回权限检查结果
    
    alt 有编辑权限
        UI->>UI: 切换到编辑模式
        UI->>UI: 设置控件可编辑
        UI->>UI: 设置白色背景
        UI->>TM: 获取模板实例
        TM-->>UI: 返回模板对象
        UI->>UI: 检查审查状态
        UI->>UI: 添加遮罩层(如需要)
        UI-->>U: 显示编辑界面
    else 无编辑权限
        UI-->>U: 显示权限不足提示
    end
```

### 2. 数据保存流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 界面层
    participant TM as 模板系统
    participant BL as 业务逻辑层
    participant DAL as 数据访问层
    participant DB as 数据库
    
    U->>UI: 点击保存按钮
    UI->>TM: 调用SaveData()
    TM->>TM: 遍历所有控件
    TM->>TM: 提取修改的数据
    TM-->>UI: 返回数据字典
    
    UI->>BL: SaveCaseDataWithTemplate()
    BL->>BL: 验证数据格式
    BL->>DAL: 保存案件详细信息
    DAL->>DB: 执行SQL插入/更新
    DB-->>DAL: 返回操作结果
    DAL-->>BL: 返回保存结果
    BL-->>UI: 返回操作状态
    
    alt 保存成功
        UI->>UI: 显示成功提示
        UI->>DAL: 重新加载数据
        UI->>UI: 更新界面显示
    else 保存失败
        UI->>UI: 显示错误提示
    end
```

### 3. 提交审查流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 界面层
    participant BL as 业务逻辑层
    participant DAL as 数据访问层
    participant DB as 数据库
    
    U->>UI: 点击提交审查按钮
    UI->>BL: SubmitForReview()
    BL->>BL: 验证数据完整性
    BL->>BL: 检查必填字段
    BL->>BL: 验证数据格式
    
    alt 验证通过
        BL->>DAL: 创建审查记录
        DAL->>DB: 插入ReviewLog记录
        DB-->>DAL: 返回操作结果
        DAL-->>BL: 返回创建结果
        BL->>DAL: 更新案件状态
        DAL->>DB: 更新Cases表状态
        DB-->>DAL: 返回更新结果
        DAL-->>BL: 返回更新结果
        BL-->>UI: 返回提交结果
        
        UI->>UI: 显示提交成功提示
        UI->>UI: 切换到审查模式
        UI->>UI: 重新加载数据
        UI->>UI: 更新界面状态
    else 验证失败
        BL-->>UI: 返回验证错误
        UI->>UI: 显示错误提示
    end
```

### 4. 遮罩管理流程

```mermaid
flowchart TD
    A[进入编辑模式] --> B[检查各标签页审查状态]
    B --> C[遍历所有标签页]
    C --> D{标签页是否有待审查记录?}
    
    D -->|是| E[创建遮罩面板]
    D -->|否| F[保持标签页可编辑]
    
    E --> G[设置半透明灰色背景]
    G --> H[添加正在审查中标签]
    H --> I[设置标签样式]
    I --> J[将遮罩添加到标签页]
    J --> K[遮罩层置顶显示]
    
    F --> L[继续检查下一个标签页]
    K --> L
    
    L --> M{是否还有标签页?}
    M -->|是| C
    M -->|否| N[遮罩管理完成]
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style G fill:#fff3e0
    style H fill:#fff3e0
    style N fill:#f1f8e9
```

### 5. 模板数据交互流程

```mermaid
sequenceDiagram
    participant UI as 界面层
    participant TF as 模板工厂
    participant TM as 模板实例
    participant BL as 业务逻辑层
    participant DAL as 数据访问层
    
    UI->>TF: CreateTemplate(caseType, tabControl)
    TF->>TF: 根据案件类型选择模板
    TF-->>UI: 返回模板实例
    
    UI->>TM: CreateTabPages(tabControl)
    TM->>TM: 创建标签页结构
    TM->>TM: 添加控件和标签
    TM-->>UI: 标签页创建完成
    
    UI->>TM: LoadData(caseDetails)
    TM->>TM: 遍历案件详细数据
    TM->>TM: 设置控件值
    TM-->>UI: 数据加载完成
    
    UI->>TM: SaveData()
    TM->>TM: 遍历所有控件
    TM->>TM: 提取控件值
    TM-->>UI: 返回数据字典
    
    UI->>BL: SaveCaseDataWithTemplate()
    BL->>DAL: 保存到数据库
    DAL-->>BL: 返回保存结果
    BL-->>UI: 返回操作状态
```

## 关键代码实现

### 1. 编辑模式设置
```vb
Private Sub SetEditMode()
    ' 编辑模式：可编辑，已提交审查的Tab显示遮罩
    tabControl.Visible = True
    panelTerminated.Visible = False
    lblTerminated.Visible = False
    
    SetControlsReadOnly(False)
    SetControlsStyle(Color.White)
    
    ' 为已提交审查的Tab添加遮罩
    AddReviewingOverlays()
    
    ' 添加保存和审查按钮
    AddActionButtons()
End Sub
```

### 2. 数据保存处理
```vb
Private Sub btnSave_Click(sender As Object, e As EventArgs)
    Try
        ' 使用模板保存案件数据
        If _currentTemplate IsNot Nothing Then
            Dim savedData = _currentTemplate.SaveData()
            Dim success As Boolean = BusinessLogic.CaseManager.SaveCaseDataWithTemplate(_caseId, savedData, _currentUser)
            If success Then
                MessageBox.Show("保存成功！", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information)
                ' 重新加载数据
                LoadCaseData()
                UpdateTabStatus()
            Else
                MessageBox.Show("保存失败！", "错误", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End If
        Else
            MessageBox.Show("模板未初始化！", "错误", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End If
    Catch ex As Exception
        MessageBox.Show($"保存失败：{ex.Message}", "错误", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Utils.LogUtil.LogError("保存案件数据失败", ex)
    End Try
End Sub
```

### 3. 遮罩层管理
```vb
Private Sub AddReviewingOverlays()
    ' 清除之前的遮罩
    ClearReviewingOverlays()
    
    ' 为已提交审查的Tab添加遮罩层
    For i As Integer = 0 To 8
        Dim tabPage As TabPage = tabControl.TabPages(i)
        Dim tabReviewLogs = _reviewLogs.Where(Function(r) r.TabIndex = i).ToList()
        
        If tabReviewLogs.Count > 0 Then
            ' 检查是否有待审查的记录
            Dim hasPendingReview = tabReviewLogs.Any(Function(r) r.ReviewStatus = "待审查")
            
            If hasPendingReview Then
                ' 创建遮罩面板
                Dim overlayPanel As New Panel With {
                    .Dock = DockStyle.Fill,
                    .BackColor = Color.FromArgb(128, 200, 200, 200), ' 半透明灰色
                    .Visible = True,
                    .Name = $"overlay_{i}"
                }
                
                ' 添加"正在审查中"标签
                Dim lblReviewing As New Label With {
                    .Text = "正在审查中",
                    .Font = New Font("微软雅黑", 14, FontStyle.Bold),
                    .ForeColor = Color.DarkBlue,
                    .AutoSize = True,
                    .Location = New Point(50, 50)
                }
                overlayPanel.Controls.Add(lblReviewing)
                
                ' 添加遮罩到TabPage
                tabPage.Controls.Add(overlayPanel)
                overlayPanel.BringToFront()
            End If
        End If
    Next
End Sub
```

## 状态转换图

```mermaid
stateDiagram-v2
    [*] --> 阅览模式
    阅览模式 --> 编辑模式 : 点击编辑按钮
    编辑模式 --> 阅览模式 : 点击阅览按钮
    编辑模式 --> 审查模式 : 提交审查
    编辑模式 --> 导出模式 : 点击导出按钮
    编辑模式 --> 中止模式 : 点击中止按钮
    
    审查模式 --> 阅览模式 : 点击阅览按钮
    审查模式 --> 编辑模式 : 审查不同意
    审查模式 --> 终了模式 : 所有Tab同意
    
    导出模式 --> 阅览模式 : 点击阅览按钮
    导出模式 --> 编辑模式 : 点击编辑按钮
    
    中止模式 --> 阅览模式 : 恢复案件
    
    终了模式 --> 阅览模式 : 点击阅览按钮
```

## 错误处理流程

```mermaid
flowchart TD
    A[操作执行] --> B{是否发生异常?}
    B -->|否| C[操作成功]
    B -->|是| D[捕获异常]
    
    D --> E[记录错误日志]
    E --> F[显示用户友好错误信息]
    F --> G[回滚操作(如需要)]
    G --> H[恢复界面状态]
    H --> I[错误处理完成]
    
    C --> J[更新界面显示]
    J --> K[操作完成]
    
    style A fill:#e1f5fe
    style D fill:#ffebee
    style E fill:#ffebee
    style F fill:#ffebee
    style C fill:#e8f5e8
    style K fill:#e8f5e8
```

## 性能优化要点

1. **模板缓存**: 模板实例可以复用，避免重复创建
2. **数据懒加载**: 按需加载标签页数据
3. **控件复用**: 控件创建时复用对象
4. **异步操作**: 大数据量操作使用异步处理
5. **内存管理**: 及时释放不需要的资源

## 安全考虑

1. **权限验证**: 每次操作前验证用户权限
2. **数据验证**: 输入数据进行格式和范围验证
3. **SQL注入防护**: 使用参数化查询
4. **XSS防护**: 对用户输入进行转义处理
5. **审计日志**: 记录重要操作的审计信息 