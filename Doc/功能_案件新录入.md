# 功能设计：案件详细录入

## 1. 功能描述
用户选择案件类型后，进入详细录入页面，分9个TabPage录入案件详细信息。

## 2. 功能实现流程
1. 用户选择案件类型后进入详细录入页面
2. 顶部左侧图片按钮返回主页面，右上角"返回"按钮返回类型选择
3. 顶部显示案件类型、页面打开时间
4. 9个TabPage，每页三四十个控件，控件Tag属性对应数据库字段
5. 点击"登录新案件"按钮，保存数据

## 3. 业务规则
- 所有控件Tag需与数据库字段一一对应
- 数据批量导入
- 支持返回、保存、提交

## 4. 使用角色
- 所有系统用户

## 5. 界面设计要求
- TabControl控件，9个TabPage
- 顶部图片按钮、类型显示、时间显示、返回按钮、登录新案件按钮
- 参考[案件详细录入示例](./UIDesign/案件详细录入示例.html) 

## 6. 保存数据规则
- 标签里至少有一个值被修改（或发生变化），保存这一页所有的tag的数据
- 有值的保存新值，无值的保存null，并且状态登录为"新登录"
- 有修改的标签页批量保存，并且更新审查记录表，插入标签页编号，状态为"新登录"
- **审查记录创建规则**：
  - 如果标签页有字段数据（控件Tag对应的数据），则创建审查记录
  - 如果标签页没有字段数据但有DataGridView数据，也会创建审查记录
  - 确保所有有内容的标签页（无论是字段数据还是表格数据）都有对应的审查记录

## 7. DataTable行状态管理（新增）

### 7.1 数据保存机制
- **DataGridView数据源**：直接使用DataTable作为DataSource
- **行状态识别**：自动识别DataTable中每行的RowState状态
  - `DataRowState.Added` - 新增行
  - `DataRowState.Modified` - 修改行
  - `DataRowState.Deleted` - 删除行
  - `DataRowState.Unchanged` - 未变更行

### 7.2 数据保存流程
1. **数据提取**：`ExtractGridData()`方法直接获取DataGridView的DataSource
2. **状态分类**：根据DataRow.RowState自动分类处理
3. **批量保存**：`SaveDataTableWithTransaction()`方法支持事务处理
4. **自动字段补全**：自动填充系统字段（更新时间、更新人员、审查日期等）

### 7.3 优势特性
- **性能优化**：避免复杂的数据结构转换，直接使用DataTable
- **状态管理**：完整保留行的增删改状态信息
- **事务安全**：支持数据库事务，确保数据一致性
- **自动维护**：自动处理系统字段，减少手动维护工作
- **向后兼容**：保持与现有数据访问层的兼容性

### 7.4 技术实现
```vb
' 数据提取示例
Dim gridData As Dictionary(Of String, (TabIndex As Integer, Table As DataTable)) = CaseManager.ExtractGridData(tabControl)

' 数据保存示例
CaseManager.CreateNewCase(caseType, tabData, gridData, currentUser)
```

### 7.5 系统字段自动处理
- **新增行**：自动设置状态为"新登录"，填充案件ID关联
- **修改行**：自动设置状态为"已修改"，更新修改时间
- **删除行**：直接从数据库中删除对应记录