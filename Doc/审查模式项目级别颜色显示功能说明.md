# 审查模式项目级别颜色显示功能说明

## 功能概述

在案件详细页面的审查模式下，系统会根据每个项目的审查历史自动设置不同的控件底色，帮助审查人员快速识别项目的审查状态。

## 颜色规则

### 1. 白色 (Color.White)
- **含义**：历史数据中没审查过的项目
- **条件**：该字段从未被审查过，或者最新审查状态为"不同意"

### 2. 灰色 (Color.LightGray)
- **含义**：审查通过的项目
- **条件**：该字段的最新审查状态为"同意"，且同意后未被重新编辑

### 3. 红色 (Color.LightCoral)
- **含义**：审查通过后的项目又被编辑提交了审查
- **条件**：该字段在审查同意后，又被重新编辑并提交审查

## 实现逻辑

### 核心方法

#### 1. SetReviewModeControlColors()
- **功能**：设置审查模式下所有可见标签页的控件颜色
- **调用时机**：进入审查模式时

#### 2. SetTabPageControlColors(tabPage, tabIndex)
- **功能**：设置指定标签页中所有控件的颜色
- **参数**：
  - `tabPage`：标签页对象
  - `tabIndex`：标签页索引

#### 3. GetControlReviewColor(tabIndex, fieldName, tabReviewLogs)
- **功能**：根据字段的审查历史确定控件颜色
- **返回**：对应的颜色值

#### 4. GetFieldReviewStatus(tabIndex, fieldName, tabReviewLogs)
- **功能**：获取字段的审查状态
- **返回**："未审查"、"已通过"、"重新编辑"

#### 5. IsFieldModifiedAfterApproval(tabIndex, fieldName, approvalTime)
- **功能**：检查字段在同意后是否被修改过
- **逻辑**：比较字段最新修改时间与同意时间

## 使用流程

### 1. 进入审查模式
1. 在案件详细页面点击"审查"按钮
2. 系统自动设置所有控件的底色
3. 根据审查历史显示不同颜色

### 2. 审查操作
1. 选择要审查的标签页
2. 查看控件的颜色状态：
   - 白色：需要审查
   - 灰色：已通过，无需重复审查
   - 红色：重新编辑，需要重新审查
3. 点击"同意"或"不同意"按钮
4. 系统自动更新控件颜色

### 3. 标签页切换
- 在审查模式下切换标签页时，系统会自动更新当前标签页的控件颜色

## 技术实现

### 数据来源
- **审查记录**：`_reviewLogs` - 存储所有审查历史
- **案件详情**：`_caseDetails` - 存储字段的修改历史

### 判断逻辑
```vb
' 伪代码示例
If 没有审查记录 Then
    返回 "未审查" (白色)
Else If 最新审查状态 = "同意" Then
    If 同意后又被修改 Then
        返回 "重新编辑" (红色)
    Else
        返回 "已通过" (灰色)
    End If
Else
    返回 "未审查" (白色)
End If
```

### 支持的控件类型
- TextBox
- ComboBox
- DateTimePicker
- RichTextBox
- CheckBox

## 注意事项

### 1. 性能考虑
- 颜色设置只在审查模式下进行
- 只在必要时更新颜色（如切换标签页、审查操作后）

### 2. 数据一致性
- 颜色显示基于数据库中的审查记录和修改历史
- 确保审查记录和修改时间的准确性

### 3. 用户体验
- 颜色变化是实时的，用户操作后立即生效
- 颜色区分明显，便于快速识别

## 扩展性

### 1. 颜色自定义
可以通过修改 `GetControlReviewColor` 方法来支持自定义颜色：
```vb
' 示例：支持配置文件中的颜色设置
Dim configColor As Color = GetColorFromConfig(reviewStatus)
Return If(configColor, defaultColor)
```

### 2. 状态扩展
可以在 `GetFieldReviewStatus` 方法中添加新的审查状态：
```vb
Case "待复审"
    Return "待复审"
Case "部分通过"
    Return "部分通过"
```

### 3. 控件扩展
可以在 `SetControlBackColor` 方法中添加对新控件类型的支持：
```vb
ElseIf TypeOf control Is NumericUpDown Then
    DirectCast(control, NumericUpDown).BackColor = backColor
```

## 测试建议

### 1. 功能测试
- 测试不同审查状态下的颜色显示
- 测试重新编辑后的颜色变化
- 测试标签页切换时的颜色更新

### 2. 边界测试
- 测试没有审查记录的情况
- 测试多次审查的状态变化
- 测试大量数据时的性能

### 3. 用户体验测试
- 验证颜色区分是否明显
- 测试颜色变化是否及时
- 确认用户理解颜色含义

## 故障排除

### 常见问题
1. **颜色不更新**
   - 检查是否在审查模式下
   - 确认审查记录是否正确加载

2. **颜色显示错误**
   - 检查字段的Tag属性是否正确设置
   - 确认审查记录的时间顺序

3. **性能问题**
   - 检查是否有不必要的颜色更新
   - 确认数据查询是否优化

### 调试方法
1. 在 `GetFieldReviewStatus` 方法中添加日志输出
2. 检查 `_reviewLogs` 和 `_caseDetails` 的数据内容
3. 验证时间比较逻辑是否正确 